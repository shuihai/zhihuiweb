<?phpnamespace Admin\Controller;class IndexController extends AdminController {    public function _initialize() {        parent::_initialize();  //RBAC 验证接口初始化    }    public function index(){        if(!$user=session('admin_user')) exit($this->redirect(C('USER_AUTH_GATEWAY')));        if($user['username'] == C('SPECIAL_USER')){     //如果是无视权限限制的用户，则获取所有主菜单            $sql = 'SELECT `id`,`title` FROM `'.C('DB_PREFIX').'node` WHERE ( `status` =1 AND `display`=1 AND `level`<>1 ) ORDER BY sort ASC';        }else{  //更具角色权限设置，获取可显示的主菜单            $sql = "SELECT `".C('DB_PREFIX')."node`.`id` as id,`".C('DB_PREFIX')."node`.`title` as title FROM `".C('DB_PREFIX')."node`,`".C('DB_PREFIX')."access` WHERE `".C('DB_PREFIX')."node`.id=`".C('DB_PREFIX')."access`.node_id AND `".C('DB_PREFIX')."access`.role_id=$user[role]  AND  `".C('DB_PREFIX')."node`.`status` =1 AND `".C('DB_PREFIX')."node`.`display`=1 AND (`".C('DB_PREFIX')."node`.`level` =0 OR `".C('DB_PREFIX')."node`.`level` =2)  ORDER BY `".C('DB_PREFIX')."node`.sort ASC";           //这个是去掉权限限制菜单 ，查询所有菜单 $sql = 'SELECT `id`,`title` FROM `'.C('DB_PREFIX').'node` WHERE ( `status` =1 AND `display`=1 AND `level`<>1 ) ORDER BY sort ASC';        }        $Model = M(); // 实例化一个model对象 没有对应任何数据表        $main_menu = $Model->query($sql);        $this->assign('main_menu',$main_menu);        $this->display();    }    public function left(){        $pid = I('id');    //选择子菜单        $NodeDB = D('Node');        $datas = $this->left_child_menu($pid);        $parent_info = $NodeDB->find($pid);        $sub_menu_html = '<dl>';        foreach($datas as $key => $_value) {            $sub_array = $this->left_child_menu($_value['id']);            if($_value['display']==3){                $display='display:none;';            }else{                $display='';            }            $href=$_value['data']? U($_value['data']) :   'javascript:void(0);';            $sub_array = $this->left_child_menu($_value['id']);            $sub_menu_html .= "<dt style='".$display."'><a href='{$href}' onclick=\"showHide('{$key}');\">{$_value[title]}</a></dt><dd><ul id='items{$key}'>";            if(is_array($sub_array)){                foreach ($sub_array as $value) {                    $href = empty($value['data']) ? 'javascript:void(0)' : U($value['data']);                    $sub_menu_html .= "<li><a id='a_{$value[id]}' onClick='sub_title({$value[id]})' href='{$href}'>{$value[title]}</a></li>";                }            }          $sub_menu_html .=  '</ul></dd>';        }        $sub_menu_html .= '</dl>';        $this->assign('sub_menu_title',$parent_info['title']);        $this->assign('sub_menu_html',$sub_menu_html);        $this->display();    }    /**     * 按父ID查找菜单子项     * @param integer $parentid   父菜单ID     * @param integer $with_self  是否包括他自己     */    private function left_child_menu($pid, $with_self = 0) {        $user=session('admin_user');        $pid = intval($pid);        if($user['username'] == C('SPECIAL_USER')){     //如果是无视权限限制的用户，则获取所有主菜单            $sql = "SELECT `id`,`data`,`title` FROM `".C('DB_PREFIX')."node` WHERE ( `status` =1 AND `display`=2 AND `level` <>1 AND `pid`=$pid ) ORDER BY sort ASC";        }else{            $sql = "SELECT `".C('DB_PREFIX')."node`.`id` as `id` , `".C('DB_PREFIX')."node`.`data` as `data`, `".C('DB_PREFIX')."node`.`title` as `title` FROM `".C('DB_PREFIX')."node`,`".C('DB_PREFIX')."access` WHERE `".C('DB_PREFIX')."node`.id = `".C('DB_PREFIX')."access`.node_id AND `".C('DB_PREFIX')."access`.role_id = $user[role] AND `".C('DB_PREFIX')."node`.`pid` =$pid AND `".C('DB_PREFIX')."node`.`status` =1 AND `".C('DB_PREFIX')."node`.`display` =2 AND `".C('DB_PREFIX')."node`.`level` <>1 ORDER BY `".C('DB_PREFIX')."node`.sort ASC";            //这个是去掉权限限制菜单 ，查询所有菜单$sql = "SELECT `id`,`data`,`title` FROM `".C('DB_PREFIX')."node` WHERE ( `status` =1 AND `display`=2 AND `level` <>1 AND `pid`=$pid ) ORDER BY sort ASC";        }        $Model = new \Think\Model(); // 实例化一个model对象 没有对应任何数据表        $result = $Model->query($sql);        if($with_self) {            $result2[] = D('Node')->getNode(array('id'=>$pid),`id`,`data`,`title`);            $result = array_merge($result2,$result);        }        return $result;    }    public function top(){        $this->display();    }    public function main(){        $this->display();    }    public function footer(){        $this->display();    }}